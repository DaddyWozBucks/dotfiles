#!/bin/bash

set -e

echo '--> Fetch latest dotfiles'
for dir in "${DOTFILES_ROOT}"/*;
do
	if [ -d "${dir}/.git" ];
  then
    (cd "${dir}"; git pull --quiet)
  fi
done

echo '--> Update latest dotfiles'
rcup

echo '--> Keep Homebrew up-to-date'
brew upgrade
brew cask upgrade
brew cleanup

echo "--> Updating Brews"
shopt -s nullglob
for brewfile in "${DOTFILES}"/{itsmycargo,local}/Brewfile;
do
  [ -e "${brewfile}" ] && $(command -v brew) bundle install --file="${brewfile}"
done
shopt -u nullglob

# Run additional update scripts
echo "--> Post-Update Scripts"
shopt -s nullglob
for script in "${DOTFILES}"/{itsmycargo,local}/post-update.d/*.sh
do
  sh "${script}"
done
shopt -u nullglob
